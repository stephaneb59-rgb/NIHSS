<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Calculateur score NIHSS</title>
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#5b8cff">
  <style>
    :root {
      --bg: #e9edf5;
      --card: #eef2f9;
      --text: #0f1218;
      --muted: #5f6b7a;
      --accent: #5b8cff;
      --ok: #19b37a;
      --warn: #ffb020;
      --bad: #ff5c7a;
      --shadow-dark: #b6c0d0;
      --shadow-light: #ffffff;
      --radius: 18px;
      --pad: 16px;
    }
    body { margin:0; font-family: sans-serif; background:var(--bg); color:var(--text); }
    .app { max-width: 600px; margin:0 auto; padding:16px; }
    .topbar { position:sticky; top:0; padding:12px; background:var(--card); box-shadow:0 2px 6px rgba(0,0,0,.2); display:flex; justify-content:center; }
    .card { background:var(--card); padding:var(--pad); border-radius:var(--radius); box-shadow:2px 2px 6px var(--shadow-dark), -2px -2px 6px var(--shadow-light); }
    .card h3 { margin-top:0; }
    .sub { color:var(--muted); font-size:14px; margin-bottom:10px; }
    .control { display:flex; flex-direction:column; gap:10px; }

    /* --- R√©ponses (s√©par√©es + √©tat s√©lectionn√© visible) --- */
    .seg {
      padding:14px;
      background:var(--bg);
      border:0;
      border-bottom:1px solid #ddd;
      text-align:left;
      font-size:16px;
      cursor:pointer;
    }
    .seg:last-child { border-bottom:0; }
    .seg[aria-pressed="true"] {
      background: var(--accent);
      color: white;
      font-weight:bold;
    }

    /* --- Boutons navigation --- */
    .card .control:last-child {
      margin-top:20px;
    }

    .btn { background:#cccc; padding:12px 16px; border-radius:12px; border:0; cursor:pointer; }
    .btn.primary { background:var(--accent); color:white; }

    .resultFinal {
      text-align:center;
      margin-top:30px;
      font-size:24px;
      font-weight:bold;
    }
    .fabbar { position:fixed; bottom:0; left:0; right:0; background:var(--bg); padding:10px; display:flex; justify-content:center; gap:12px; }
    .chip { padding:8px 12px; border-radius:999px; background:var(--card); }
    .pill { font-weight:bold; }
    .ok{color:var(--ok);} .warn{color:var(--warn);} .bad{color:var(--bad);}
  </style>
</head>
<body>
  <div class="topbar"><h1>Calcul NIHSS SB ¬Æ</h1></div>
  <main class="app">
    <section id="questions"></section>
    <section id="summary">
      <strong>R√©sum√©</strong>
      <div class="sub" id="chosenCount">0/15 √©l√©ments renseign√©s</div>
    </section>
    <div id="finalResult" class="resultFinal" style="display:none;"></div>
  </main>
  <div class="fabbar">
    <div class="chip">Score <span id="scoreVal" class="pill">0</span></div>
    <div class="chip">Gravit√© <span id="band" class="pill ok">minime</span></div>
  </div>

<script>
  const NIHSS = [
      { id: '1a', label: '1a. Niveau de conscience', desc:'√âveil global', options:[
        {t:'Vigilant', v:0}, {t:'R√©pond aux stimulations simples', v:1}, {t:'R√©ponse motice non st√©r√©otyp√©e √† la douleur', v:2}, {t:'Coma', v:3}
      ]},
      { id: '1b', label: '1b. R√©ponses √† 2 questions simples', desc:'Questions : √¢ge / mois', options:[
        {t:'2 bonnes r√©ponses', v:0}, {t:'1 bonne r√©ponse ou dysarthrie s√©v√®re ', v:1}, {t:'0 bonne r√©ponse ou aphasie', v:2}
      ]},
      { id: '1c', label: '1c. R√©ponses √† 2 t√¢ches simples', desc:'Ouvrir et fermer les yeux / serrer et relacher la main', options:[
        {t:'2 bonnes r√©ponses', v:0}, {t:'1 bonne r√©ponse', v:1}, {t:'0 bonne r√©ponse', v:2}
      ]},
      { id: '2', label: '2. Occulomotricit√©', desc:'Paires cr√¢niennes III, IV, VI', options:[
        {t:'Normale', v:0}, {t:'Paralysie de la lat√©ralit√© partielle ou diplopie', v:1}, {t:'Paralysie de la lat√©ralit√© compl√®te', v:2}
      ]},
      { id: '3', label: '3. Champs visuels', desc:'H√©mianopsie lat√©rale homonyme : HLH', options:[
        {t:'Normal', v:0}, {t:'HLH partielle', v:1}, {t:'HLH compl√®te', v:2}, {t:'Double HLH ou c√©cit√© corticale', v:3}
      ]},
      { id: '4', label: '4. Paralysie faciale : PF', desc:'montrer les dents, fermer les yeux, hausser les sourcils', options:[
        {t:'Pas d asym√©trie', v:0}, {t:'L√©g√®re asym√©trie : PF discr√®te', v:1}, {t:'PF nette', v:2}, {t:'Compl√®te : double PF', v:3}
      ]},
      { id: '5a', label: '5a. √âlevation du Mb sup√©rieur (commencer par le cot√© non par√©tique)', desc:'Assis bras tendu √† 90¬∞ - allong√© bras tendu √† 45¬∞ ', options:[
        {t:'Maintenu 10 s', v:0}, {t:'R√©siste √† la pesenteur', v:1}, {t:'Ne r√©site pas √† la peusanteur', v:2}, {t:'Ne l√®ve pas', v:3}, {t:'Aucun mouvement', v:4}
      ]},
      { id: '5b', label: '5b. El√©vation Mb sup√©rieur controlat√©ral', desc:'Assis bras tendu √† 90¬∞ - allong√© bras tendu √† 45¬∞ : Maintien 10 s', options:[
        {t:'Maintenu 10 s', v:0}, {t:'R√©siste √† la pesenteur', v:1}, {t:'Ne r√©site pas √† la peusanteur', v:2}, {t:'Ne l√®ve pas', v:3}, {t:'Aucun mouvement', v:4}
      ]},
      { id: '6a', label: '6a. √âlevation du Mb inf√©rieur (commencer par le cot√© non par√©tique)', desc:'allong√© jambe tendue √† 30¬∞ : Maintien 5 s', options:[
        {t:'Maintenu 10 s', v:0}, {t:'R√©siste √† la pesenteur', v:1}, {t:'Ne r√©site pas √† la peusanteur', v:2}, {t:'Ne l√®ve pas', v:3}, {t:'Aucun mouvement', v:4}
      ]},
      { id: '6b', label: '6b. El√©vation Mb inf√©rieur controlat√©ral', desc:'allong√© jambe tendue √† 30¬∞ : Maintien 5 s', options:[
        {t:'Maintenu 5 s', v:0}, {t:'R√©siste √† la pesenteur', v:1}, {t:'Ne r√©site pas √† la peusanteur', v:2}, {t:'Ne l√®ve pas', v:3}, {t:'Aucun mouvement', v:4}
      ]},
      { id: '7', label: '7. Ataxie des membres - syndrome c√©r√©belleux cin√©tique', desc:'√âpreuve doigt-nez / talon-genou', options:[
        {t:'Absent ou non r√©alisable', v:0}, {t:'pr√©sent sur 1 membre', v:1}, {t:'pr√©sent sur 2 membres', v:2}
      ]},
      { id: '8', label: '8. Troubles sensitifs', desc:'Comparaison piq√ªre / toucher : visage + parties proximales des 4 Mb', options:[
        {t:'Absence', v:0}, {t:'Hypoesth√©sie', v:1}, {t:'Anesth√©sie', v:2}
      ]},
      { id: '9', label: '9. Langage - Aphasie', desc:'Description objets - sc√®ne - lecture de phrases', options:[
        {t:'Absente', v:0}, {t:'Aphasie mais communique', v:1}, {t:'Aphasie s√©v√®re : Communication quasi impossible', v:2}, {t:'Mutique', v:3}
      ]},
      { id: '10', label: '10. Dysarthrie', desc:'Articulation et claret√© parole - carte de mots', options:[
        {t:'Absente', v:0}, {t:'Compr√©hensible : Minime √† mod√©r√©e', v:1}, {t:'Incompr√©hensible : S√©v√®re-mutique', v:2}
      ]},
      { id: '11', label: '11. N√©gligeance / Extinction', desc:'Patient yeux ferm√©s : Le toucher avec comapratif Dt/G - Patient regarde le nez + mouvements avec comapratifs Dt/G ', options:[
        {t:'Absente', v:0}, {t:'Partielle : Extinction √† 1 modallit√© snsitive', v:1}, {t:'Extinction plurimodale ou h√©min√©gligence s√©v√®re', v:2}
      ]}
    ];

    let currentIndex = 0;
  // map index -> step (0 = first image, 1 = second image, 2 = reveal options)
  const imgSteps = {};
  const grid = document.getElementById('questions');
  const finalResult = document.getElementById('finalResult');

  function bandFrom(score){
    if(score<=3) return {txt:'minime', cls:'ok'};
    if(score<=10) return {txt:'mod√©r√©', cls:'warn'};
    return {txt:'s√©v√®re', cls:'bad'};
  }

  // utilitaire pour cr√©er une <img> robuste (g√®re accents, ./ ou sans)
  function makeRobustImage(srcPath, altText) {
    const img = document.createElement('img');
    img.loading = 'lazy';
    img.className = 'obj-img';
    img.alt = altText || '';

    function setSrc(p) {
      try {
        img.src = new URL(encodeURI(p), location.href).href;
      } catch (e) {
        img.src = p;
      }
    }

    setSrc(srcPath);

    img.onerror = () => {
      console.warn('√âchec chargement image, tentative alternative pour :', srcPath);
      // tenter variante sans ./ si pr√©sent
      if (srcPath.startsWith('./')) {
        const alt = srcPath.slice(2);
        setSrc(alt);
      } else {
        setSrc('./' + srcPath);
      }
      // si nouvel √©chec, afficher message
      img.onerror = () => {
        console.error('Image introuvable :', srcPath);
        const note = document.createElement('div');
        note.className = 'img-error';
        note.textContent = 'Image introuvable : ' + srcPath;
        img.replaceWith(note);
      };
    };

    return img;
  }

  function renderQuestion(){
    grid.innerHTML = '';
    finalResult.style.display = 'none';
    const q = NIHSS[currentIndex];
    const card = document.createElement('article'); card.className = 'card';
    const h3 = document.createElement('h3'); h3.textContent = q.label;
    const sub = document.createElement('div'); sub.className = 'sub'; sub.textContent = q.desc;
    const ctrl = document.createElement('div'); ctrl.className = 'control';

    // init step for this question if absent
    if (imgSteps[currentIndex] === undefined) imgSteps[currentIndex] = 0;
    const step = imgSteps[currentIndex];

    // --- question 9 : objets -> sc√®ne (index 3) ---
    if (currentIndex === 13) {
      const imgWrap = document.createElement('div'); imgWrap.className = 'img-wrap';
      // NB: filename in repo is "scene.png" (accent). makeRobustImage handles encoding.
      const images = [
        {src: './objets.png', alt: 'objets √† d√©crire', title: 'Objets'},
        {src: './scene.png', alt: 'sc√®ne', title: 'Sc√®ne'}
      ];
      const visibleImgIndex = Math.min(step, 1);
      const img = makeRobustImage(images[visibleImgIndex].src, images[visibleImgIndex].alt);
      imgWrap.appendChild(img);

      const actions = document.createElement('div'); actions.className = 'img-actions';
      const fullscreenBtn = document.createElement('button'); fullscreenBtn.className = 'btn'; fullscreenBtn.textContent = 'Plein √©cran';
      fullscreenBtn.onclick = async () => {
        try {
          if (img.requestFullscreen) await img.requestFullscreen();
          else if (img.webkitRequestFullscreen) img.webkitRequestFullscreen();
          else window.open(img.src, '_blank');
        } catch (err) {
          window.open(img.src, '_blank');
        }
      };

      const stepBtn = document.createElement('button'); stepBtn.className = 'btn primary';
      stepBtn.textContent = step === 0 ? 'Sc√®ne √† d√©crire' : 'Suivant';
      stepBtn.onclick = () => {
        if (imgSteps[currentIndex] === 0) {
          imgSteps[currentIndex] = 1;
          renderQuestion();
        } else if (imgSteps[currentIndex] === 1) {
          imgSteps[currentIndex] = 2;
          renderQuestion();
          setTimeout(() => {
            const optContainer = document.querySelector('.control.options-container');
            if (optContainer) optContainer.scrollIntoView({behavior:'smooth', block:'start'});
          }, 50);
        }
      };

      img.onclick = () => fullscreenBtn.click();

      actions.appendChild(fullscreenBtn);
      actions.appendChild(stepBtn);
      imgWrap.appendChild(actions);
      card.append(h3, sub, imgWrap);

      ctrl.className = 'control options-container' + (step < 2 ? ' hidden-options' : '');
    }
    // --- question 10 : mots -> phrases (index 4) ---
    else if (currentIndex === 14) {
      const imgWrap = document.createElement('div'); imgWrap.className = 'img-wrap';
      const images = [
        {src: './mots.png', alt: 'carte de mots', title: 'Mots'},
      ];
      const visibleImgIndex = Math.min(step, 1);
      const img = makeRobustImage(images[visibleImgIndex].src, images[visibleImgIndex].alt);
      imgWrap.appendChild(img);

      const actions = document.createElement('div'); actions.className = 'img-actions';
      const fullscreenBtn = document.createElement('button'); fullscreenBtn.className = 'btn'; fullscreenBtn.textContent = 'Plein √©cran';
      fullscreenBtn.onclick = async () => {
        try {
          if (img.requestFullscreen) await img.requestFullscreen();
          else if (img.webkitRequestFullscreen) img.webkitRequestFullscreen();
          else window.open(img.src, '_blank');
        } catch (err) {
          window.open(img.src, '_blank');
        }
      };

      const stepBtn = document.createElement('button'); stepBtn.className = 'btn primary';
      // premi√®re √©tape label demand√© : "Phrases √† lire"
      stepBtn.textContent = step === 0 ? 'Phrases √† lire' : 'Suivant';
      stepBtn.onclick = () => {
        if (imgSteps[currentIndex] === 0) {
          imgSteps[currentIndex] = 1;
          renderQuestion();
        } else if (imgSteps[currentIndex] === 1) {
          imgSteps[currentIndex] = 2;
          renderQuestion();
          setTimeout(() => {
            const optContainer = document.querySelector('.control.options-container');
            if (optContainer) optContainer.scrollIntoView({behavior:'smooth', block:'start'});
          }, 50);
        }
      };

      img.onclick = () => fullscreenBtn.click();

      actions.appendChild(fullscreenBtn);
      actions.appendChild(stepBtn);
      imgWrap.appendChild(actions);
      card.append(h3, sub, imgWrap);

      // IMPORTANT: options are cach√©es tant que step < 2 ‚Äî donc les r√©ponses n'apparaissent qu'apr√®s la 2√®me image
      ctrl.className = 'control options-container' + (step < 2 ? ' hidden-options' : '');
    }
    else {
      card.append(h3, sub);
      ctrl.className = 'control';
    }

    // construire les boutons de r√©ponses (toujours ajout√©s au ctrl)
    q.options.forEach(opt=>{
      const b = document.createElement('button');
      b.className = 'seg'; b.textContent = opt.t; b.setAttribute('aria-pressed','false');
      b.onclick = () => {
        [...ctrl.children].forEach(ch => ch.setAttribute('aria-pressed','false'));
        b.setAttribute('aria-pressed','true');
        q.selected = opt.v;
        update();
      };
      if (q.selected !== undefined && q.selected === opt.v) {
        b.setAttribute('aria-pressed','true');
      }
      ctrl.appendChild(b);
    });

    card.append(ctrl);

    const nav = document.createElement('div'); nav.className = 'control';
    if (currentIndex > 0) {
      const prev = document.createElement('button'); prev.className = 'btn'; prev.textContent = 'Pr√©c√©dent';
      prev.onclick = () => { currentIndex--; renderQuestion(); }; nav.appendChild(prev);
    }
    if (currentIndex < NIHSS.length - 1) {
      const next = document.createElement('button'); next.className = 'btn primary'; next.textContent = 'Suivant';
      next.onclick = () => { currentIndex++; renderQuestion(); }; nav.appendChild(next);
    } else {
      const endBtn = document.createElement('button'); endBtn.className = 'btn primary'; endBtn.textContent = 'Fin';
      endBtn.onclick = () => { showFinal(); };
      nav.appendChild(endBtn);
    }
    card.appendChild(nav);

    grid.appendChild(card);
  }

  function update(){
    let score=0, filled=0;
    NIHSS.forEach(q=>{ if(q.selected!==undefined){ score+=q.selected; filled++; }});
    document.getElementById('scoreVal').textContent = score;
    const {txt, cls} = bandFrom(score);
    const band = document.getElementById('band'); band.textContent = txt; band.className = `pill ${cls}`;
    document.getElementById('chosenCount').textContent = `${filled}/${NIHSS.length} √©l√©ments renseign√©s`;
  }

  function showFinal(){
    let score=0;
    NIHSS.forEach(q=>{ if(q.selected!==undefined) score+=q.selected; });
    const {txt, cls} = bandFrom(score);
    finalResult.style.display='block';
    finalResult.innerHTML = `Score total: ${score}<br>Gravit√©: <span class="${cls}">${txt}</span>`;
  }

  window.onload = () => {
    NIHSS.forEach(q => delete q.selected);
    currentIndex = 0;
    renderQuestion();
    update();
  };
</script>

<!-- Enregistrement du service worker -->
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("sw.js");
  }
</script>
<button id="installBtn" hidden class="install-btn">üì≤ Installer NIHSS</button>

<script>
let deferredPrompt;

window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  document.getElementById('installBtn').hidden = false;
});

document.getElementById('installBtn').addEventListener('click', async () => {
  document.getElementById('installBtn').hidden = true;
  deferredPrompt.prompt();
  const { outcome } = await deferredPrompt.userChoice;
  console.log(`R√©sultat : ${outcome}`);
  deferredPrompt = null;
});
</script>

<style>
.install-btn {
  position: fixed;
  bottom: 20px;
  right: 20px;
  background: #5b8cff;
  color: white;
  border: none;
  border-radius: 1em;
  padding: 12px 20px;
  font-size: 1rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.2);
}
</style>

</body>
</html>



